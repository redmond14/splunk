### Zeek is an open-source network analysis tool. The engine analysis live or recorded network traffic and interprets what it sees and create compact, high-fidelity transaction logs, file content and fully customizable output.
more information: https://zeek.org/

1. We are going to use Zeek to find beacons in the pre-recorded network traffic, in PCAP files.
- Login to Kali and install Zeek
```bash
echo 'deb http://download.opensuse.org/repositories/security:/zeek/Debian_12/ /' | sudo tee /etc/apt/sources.list.d/security:zeek.list
curl -fsSL https://download.opensuse.org/repositories/security:zeek/Debian_12/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/security_zeek.gpg > /dev/null
sudo apt update
sudo apt install zeek
```

2. Add Zeek to the PATH
```bash
export PATH="/opt/zeek/bin:$PATH"
```

3. check the Zeek version:
```bash
$ zeek -v
zeek version 6.2.1
```

4. Zeek creates many file types from the PCAP. Like, conn, dns, files, http, ssl etc.
<br>
First download a PCAP which is 24h capture and includes Zeus botnet traffic as well.

```bash
mkdir zeek
cd zeek
``` 
```bash
wget https://www.dropbox.com/s/s2fs42a30z5xp36/zeus_24hr.pcap?dl=0
```

5. Check the file structure and infos with capinfos
```bash
capinfos zeus_24hr.pcap
```
![](attachments/3.0-capinfo.png)

6. Create Zeek files from the PCAP.
```bash
zeek -C -r zeus_24hr.pcap "tcp_inactivity_timeout = 60 min;"

$ ls                            
conn.log  dns.log    http.log  ocsp.log           ssl.log   zeus_24hr.pcap
dhcp.log  files.log  ntp.log   packet_filter.log  x509.log
```

7. List the content of conn.log. Use flag -S for screen width to the chopped
```bash
less -S conn.log
```
---
![](attachments/3.0-zeek1.png)

8. List the the top 10 most active destination
- id.resp_h --> destination IP
- id.resp_p --> destination port
- service --> detected service type by Zeek engine
- sort --> it's a linux tool, sorts the output in order
- uniq -c --> print only once the same lines and -c tells to it to count the same numbers
- sort -rn --> sort the output in a revers order
- head --> list the top 10 only

```bash
cat conn.log | zeek-cut id.resp_h id.resp_p service | sort | uniq -c | sort -rn | head
```

9. Lets find out the source machine
```bash
cat conn.log | zeek-cut id.orig_h id.resp_h id.resp_p | grep 67.207.93.135 | sort | uniq -c

2882 192.168.99.53	67.207.93.135	80
```

10. Examine the distribution of suspicious beacons over a 24-hour period
- create a small script (credit goes to Chris Benton)
```bash
$touch beacon-frequency
$nano beacon-frequency

cat conn.* | zeek-cut -d ts id.orig_h id.resp_h | grep $1 | grep $2 | sed 's/T/:/g' | cut -d ':' -f 2 | sort | uniq -c | tr -s " " | awk '{ print $2 " " $1}'
```